<%- include('partials/header') %>
    
    <% const currentUrl = '/subject/' + subject._id; %>
    
    <!-- Mobile Toggle Button (Visible only on mobile) -->
    <div class="d-block d-md-none bg-white border-bottom p-3 sticky-top" style="top: 56px; z-index: 1020;">
        <button class="btn btn-primary w-100 shadow-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas">
            <i class="fas fa-list me-2"></i> Browse Topics & Papers
        </button>
    </div>

    <div class="row flex-nowrap h-100 g-0">
        <!-- Sidebar (Desktop) -->
        <div class="col-md-3 col-lg-3 d-none d-md-block" data-aos="fade-right">
            <div class="sticky-top" style="top: 90px; height: 85vh;">
                <%- include('partials/subject-sidebar', { currentUrl: currentUrl }) %>
            </div>
        </div>

        <!-- Sidebar (Mobile Offcanvas) -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas">
            <div class="offcanvas-header bg-light">
                <h5 class="offcanvas-title fw-bold"><i class="fas fa-book me-2"></i>Subject Menu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body p-0">
                <%- include('partials/subject-sidebar', { currentUrl: currentUrl }) %>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-9 ms-md-auto px-4 pb-5 pt-3">
            <% if (activeTopic) { %>
                <div class="content-wrapper" data-aos="fade-up">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-start border-bottom pb-3 mb-4">
                        <div>
                            <span class="badge bg-light text-primary border mb-2"><%= activeTopic.chapterName %></span>
                            <h1 class="h2 fw-bold mb-0 text-dark"><%= activeTopic.title %></h1>
                            <small class="text-muted"><i class="far fa-clock me-1"></i> Posted on <%= new Date(activeTopic.createdAt).toLocaleDateString() %></small>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-outline-dark btn-sm shadow-sm" onclick="downloadPDF()">
                                <i class="fas fa-file-pdf me-1"></i> Save PDF
                            </button>

                            <% if (typeof user !== 'undefined' && user) { %>
                                <div class="btn-group shadow-sm" role="group">
                                    <input type="radio" class="btn-check status-check" name="status" id="unread" value="unread" <%= (!userProgress || userProgress.status === 'unread') ? 'checked' : '' %>>
                                    <label class="btn btn-outline-secondary btn-sm" for="unread"><i class="far fa-eye-slash me-1"></i>Unread</label>
    
                                    <input type="radio" class="btn-check status-check" name="status" id="read" value="read" <%= (userProgress && userProgress.status === 'read') ? 'checked' : '' %>>
                                    <label class="btn btn-outline-success btn-sm" for="read"><i class="far fa-check-circle me-1"></i>Read</label>
    
                                    <input type="radio" class="btn-check status-check" name="status" id="revise" value="revise" <%= (userProgress && userProgress.status === 'revise') ? 'checked' : '' %>>
                                    <label class="btn btn-outline-warning btn-sm" for="revise"><i class="far fa-star me-1"></i>Revise</label>
                                </div>
                            <% } %>
                        </div>
                    </div>

                    <!-- Admin Delete -->
                    <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
                        <div class="text-end mb-3">
                            <form action="/admin/topic/<%= activeTopic._id %>?_method=DELETE" method="POST" class="d-inline">
                                <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this topic?')"><i class="fas fa-trash me-1"></i> Delete Topic</button>
                            </form>
                        </div>
                    <% } %>

                    <!-- Content -->
                    <div class="content-area mb-5">
                        <%- activeTopic.content %>
                    </div>

                    <!-- Attachments Section -->
                    <% if (activeTopic.attachments && activeTopic.attachments.length > 0) { %>
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header bg-light fw-bold">
                                <i class="fas fa-paperclip me-2"></i> Attachments / Resources
                            </div>
                            <ul class="list-group list-group-flush">
                                <% activeTopic.attachments.forEach(file => { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <% if (file.filename.endsWith('.pdf')) { %>
                                                <i class="fas fa-file-pdf text-danger me-3 fa-lg"></i>
                                            <% } else if (file.filename.match(/\.(jpg|jpeg|png|gif)$/i)) { %>
                                                <i class="fas fa-file-image text-primary me-3 fa-lg"></i>
                                            <% } else { %>
                                                <i class="fas fa-file-alt text-secondary me-3 fa-lg"></i>
                                            <% } %>
                                            <span><%= file.originalname %></span>
                                        </div>
                                        <a href="<%= file.path %>" class="btn btn-sm btn-outline-primary" download>
                                            <i class="fas fa-download me-1"></i> Download
                                        </a>
                                    </li>
                                <% }) %>
                            </ul>
                        </div>
                    <% } %>

                    <!-- Navigation Buttons -->
                    <div class="d-flex justify-content-between mt-5 pt-4 border-top">
                        <% if (prevTopic) { %>
                            <a href="/subject/<%= subject._id %>?topicId=<%= prevTopic._id %>" class="btn btn-light border hover-card px-4">
                                <i class="fas fa-arrow-left me-2"></i> Previous: <%= prevTopic.title %>
                            </a>
                        <% } else { %>
                            <div></div>
                        <% } %>

                        <% if (nextTopic) { %>
                            <a href="/subject/<%= subject._id %>?topicId=<%= nextTopic._id %>" class="btn btn-primary px-4 shadow-sm hover-card">
                                Next: <%= nextTopic.title %> <i class="fas fa-arrow-right ms-2"></i>
                            </a>
                        <% } %>
                    </div>

                    <!-- Personal Notes -->
                    <% if (typeof user !== 'undefined' && user) { %>
                        <div class="mt-5 pt-3">
                            <h5 class="fw-bold mb-3"><i class="fas fa-pen-fancy me-2 text-primary"></i>My Notes</h5>
                            <div class="bg-light p-3 rounded-3 border">
                                <textarea id="personalNote" class="form-control border-0 bg-white shadow-sm mb-3" rows="3" placeholder="Jot down key points, doubts, or summaries..."><%= userProgress ? userProgress.note : '' %></textarea>
                                <div class="d-flex align-items-center">
                                    <button id="saveNoteBtn" class="btn btn-dark btn-sm rounded-pill px-4">Save Note</button>
                                    <span id="saveStatus" class="ms-3 text-success small fw-bold"></span>
                                </div>
                            </div>
                        </div>
                    <% } %>

                    <!-- Discussion / Doubt Section -->
                    <div class="mt-5 pt-3 border-top" id="comments-section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold m-0"><i class="fas fa-comments me-2 text-primary"></i>Discussion & Doubts</h5>
                            <span class="badge bg-light text-dark"><%= (typeof comments !== 'undefined' && comments) ? comments.length : 0 %> Comments</span>
                        </div>

                        <!-- Comment Form -->
                        <% if (typeof user !== 'undefined' && user) { %>
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-body bg-light rounded-3">
                                    <form action="/subject/<%= subject._id %>/topic/<%= activeTopic._id %>/comment" method="POST">
                                        <div class="d-flex gap-3">
                                            <div class="flex-shrink-0">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-weight: bold;">
                                                    <i class="fas fa-user"></i> 
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <textarea name="content" class="form-control border-0 shadow-sm mb-2" rows="2" placeholder="Ask a question or share a thought..." required></textarea>
                                                <div class="text-end">
                                                    <button type="submit" class="btn btn-primary btn-sm px-4 rounded-pill">Post Comment</button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        <% } else { %>
                            <div class="alert alert-light border text-center mb-4">
                                <a href="/login" class="text-decoration-none fw-bold">Login</a> to join the discussion.
                            </div>
                        <% } %>

                        <!-- Comments List -->
                        <div class="comments-list">
                            <% if (typeof comments !== 'undefined' && comments && comments.length > 0) { %>
                                <% comments.forEach(comment => { %>
                                    <div class="d-flex gap-3 mb-4">
                                        <div class="flex-shrink-0">
                                            <div class="<%= comment.user && comment.user.role === 'admin' ? 'bg-danger' : 'bg-secondary' %> text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-size: 0.8rem;">
                                                <% if (comment.user && comment.user.role === 'admin') { %>
                                                    <i class="fas fa-crown"></i>
                                                <% } else { %>
                                                    <i class="fas fa-user-graduate"></i>
                                                <% } %>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="bg-white p-3 rounded-3 shadow-sm border position-relative">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <div>
                                                        <span class="fw-bold text-dark me-2"><%= comment.user ? comment.user.username : 'Unknown User' %></span>
                                                        <% if (comment.user && comment.user.role === 'admin') { %>
                                                            <span class="badge bg-danger py-0" style="font-size: 0.6rem;">ADMIN</span>
                                                        <% } %>
                                                        <span class="text-muted small ms-2"><i class="far fa-clock me-1"></i><%= new Date(comment.createdAt).toLocaleDateString() %></span>
                                                    </div>
                                                    
                                                    <% if (typeof user !== 'undefined' && user && comment.user && (user.role === 'admin' || user._id.toString() === comment.user._id.toString())) { %>
                                                        <form action="/comment/<%= comment._id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Delete this comment?')">
                                                            <button type="submit" class="btn btn-link text-muted p-0" style="font-size: 0.8rem;"><i class="fas fa-trash"></i></button>
                                                        </form>
                                                    <% } %>
                                                </div>
                                                <p class="mb-0 text-secondary" style="white-space: pre-wrap; font-size: 0.95rem;"><%= comment.content %></p>
                                            </div>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } else { %>
                                <div class="text-center text-muted py-3">
                                    <i class="far fa-comments fa-2x mb-2 opacity-50"></i>
                                    <p class="small">No comments yet. Be the first to start a conversation!</p>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>

            <% } else { %>
                <div class="text-center mt-5 pt-5" data-aos="zoom-in">
                    <div class="p-5 bg-white rounded-3 shadow-sm d-inline-block">
                        <i class="fas fa-book-reader fa-3x text-muted mb-4"></i>
                        <h3 class="fw-bold">Select a topic to start</h3>
                        <p class="text-muted">Choose a chapter from the sidebar to begin your study session.</p>
                        <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
                             <a href="/admin/subject/<%= subject._id %>/add-topic" class="btn btn-primary mt-3">Create First Topic</a>
                        <% } %>
                    </div>
                </div>
            <% } %>
        </div>
    </div>

    <!-- JavaScript for Progress Tracking -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const topicId = '<%= activeTopic ? activeTopic._id : "" %>';
            if (!topicId) return;

            // Handle Status Change
            const statusRadios = document.querySelectorAll('.status-check');
            statusRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updateProgress(topicId, e.target.value, null);
                });
            });

            // Handle Note Save
            const saveBtn = document.getElementById('saveNoteBtn');
            const noteArea = document.getElementById('personalNote');
            const statusSpan = document.getElementById('saveStatus');

            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    statusSpan.innerText = 'Saving...';
                    updateProgress(topicId, null, noteArea.value);
                });
            }

            function updateProgress(topicId, status, note) {
                const data = { topicId };
                if (status) data.status = status;
                if (note !== null) data.note = note;

                fetch('/api/progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (note !== null) {
                            statusSpan.innerText = 'Saved Successfully!';
                            setTimeout(() => statusSpan.innerText = '', 2000);
                        }
                    } else {
                        alert('Error saving progress');
                    }
                })
                .catch(err => console.error(err));
            }
        });
    </script>
<%- include('partials/footer') %>

<!-- HTML2PDF Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    function downloadPDF() {
        const element = document.querySelector('.content-area');
        const opt = {
            margin:       [10, 10], // Top/Bottom margin
            filename:     '<%= activeTopic ? activeTopic.title : "document" %>.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };
        // Use html2pdf to download
        html2pdf().set(opt).from(element).save();
    }
</script>
