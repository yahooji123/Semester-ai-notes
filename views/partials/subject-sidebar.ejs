<div class="sidebar p-3 rounded-3 shadow-sm h-100 bg-white" style="overflow-y: auto;">
    <a href="/" class="btn btn-light btn-sm w-100 mb-4 text-start fw-bold text-muted">
        <i class="fas fa-arrow-left me-2"></i> All Subjects
    </a>
    <h5 class="fw-bold mb-4 px-2 border-start border-4 border-primary ps-2"><%= subject.name %></h5>
    
    <div class="d-grid gap-2 mb-4">
         <a href="/subject/<%= subject._id %>" class="btn <%= !currentUrl.includes('/papers') ? 'btn-primary' : 'btn-outline-primary' %> btn-sm text-start">
            <i class="fas fa-book-open me-2"></i> Study Notes
         </a>
         <a href="/subject/<%= subject._id %>/papers" class="btn <%= currentUrl.includes('/papers') ? 'btn-primary' : 'btn-outline-primary' %> btn-sm text-start">
            <i class="fas fa-file-alt me-2"></i> Question Papers
         </a>
         <!-- Download ALL PDF -->
         <a href="/subject/<%= subject._id %>/download-notes" target="_blank" class="btn btn-warning btn-sm text-start text-dark fw-bold">
            <i class="fas fa-file-pdf me-2"></i> Download Full PDF
         </a>
    </div>

    <hr>

    <% if (typeof chapters !== 'undefined') { %>
        <% for (const [chapter, topicList] of Object.entries(chapters)) { %>
            <div class="mb-3">
                <h6 class="text-uppercase text-muted fw-bold px-2 mb-2" style="font-size: 0.75rem;"><%= chapter %></h6>
                <div class="d-flex flex-column gap-1">
                    <% topicList.forEach(topic => { %>
                        <a href="/subject/<%= subject._id %>?topicId=<%= topic._id %>" 
                        class="sidebar-link px-3 py-2 text-decoration-none d-flex align-items-center <%= (typeof activeTopic !== 'undefined' && activeTopic && activeTopic._id.toString() === topic._id.toString()) ? 'active' : '' %>">
                            <% if (typeof activeTopic !== 'undefined' && activeTopic && activeTopic._id.toString() === topic._id.toString()) { %>
                                <i class="fas fa-play-circle me-2 small"></i>
                            <% } else { %>
                                <i class="far fa-circle me-2 small text-muted" style="font-size: 0.6rem;"></i>
                            <% } %>
                            <span class="text-truncate"><%= topic.title %></span>
                        </a>
                    <% }) %>
                </div>
            </div>
        <% } %>
    <% } %>

    <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
        <div class="mt-4 pt-3 border-top pb-5">
            <a href="/admin/subject/<%= subject._id %>/add-topic" class="btn btn-dark btn-sm w-100 shadow-sm"><i class="fas fa-plus me-1"></i> Add New Topic</a>
        </div>
    <% } %>
</div>